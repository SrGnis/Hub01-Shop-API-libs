name: Publish Rust crate to crates.io

on:
  workflow_dispatch:
  push:
    tags:
      - 'rust_*'

permissions:
  contents: read

jobs:
  validate-tag-version:
    name: Validate tag/version match
    runs-on: ubuntu-latest
    outputs:
      crate_version: ${{ steps.extract.outputs.crate_version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract and validate versions
        id: extract
        shell: bash
        run: |
          set -euo pipefail

          TAG_VERSION="${GITHUB_REF_NAME#rust_}"
          if [[ -z "${TAG_VERSION}" ]]; then
            echo "Tag must follow rust_X.Y.Z format"
            exit 1
          fi

          CARGO_VERSION="$(sed -n 's/^version = "\(.*\)"/\1/p' rust/Cargo.toml | head -n1)"
          if [[ -z "${CARGO_VERSION}" ]]; then
            echo "Could not read package.version from rust/Cargo.toml"
            exit 1
          fi

          if [[ "${TAG_VERSION}" != "${CARGO_VERSION}" ]]; then
            echo "Tag version (${TAG_VERSION}) does not match Cargo.toml version (${CARGO_VERSION})"
            exit 1
          fi

          echo "crate_version=${CARGO_VERSION}" >> "${GITHUB_OUTPUT}"

  verify:
    name: Build and test
    needs: validate-tag-version
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cargo check
        run: cargo check --manifest-path rust/Cargo.toml --locked

  publish:
    name: Publish to crates.io
    needs:
      - validate-tag-version
      - verify
    runs-on: ubuntu-latest
    environment:
      name: rust
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/rust_')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Publish crate
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: cargo publish --manifest-path rust/Cargo.toml --locked
